@model CheckoutVM
@{
    ViewData["Title"] = "Checkout";
}

<div class="container mb-5">
    <form asp-action="PlaceOrder" method="post">
        <div class="row">
            <!-- Main Checkout Form -->
            <div class="col-lg-8">
                <!-- Shipping Address -->
                <div class="checkout-card mb-4">
                    <div class="card-body p-4">
                        <h2 class="h4 mb-3">Shipping Address</h2>
                        <hr>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="@Model.ShippingAddress.Name" class="form-label"></label>
                                <input asp-for="@Model.ShippingAddress.Name" class="form-control" id="shipping-name" required>
                                <span asp-validation-for="@Model.ShippingAddress.Name" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label asp-for="@Model.ShippingAddress.StreetAddress" class="form-label">Address</label>
                                <input asp-for="@Model.ShippingAddress.StreetAddress" class="form-control" id="shipping-line" required>
                                <span asp-validation-for="@Model.ShippingAddress.StreetAddress" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="@Model.ShippingAddress.City" class="form-label"></label>
                                <select asp-for="@Model.ShippingAddress.City" class="form-select" id="shipping-city" required>
                                    <option value="">Choose...</option>
                                    <option value="Dhaka">Dhaka</option>
                                    <option value="Rajshahi">Rajshahi</option>
                                    <option value="Sylhet">Sylhet</option>
                                </select>
                                <span asp-validation-for="@Model.ShippingAddress.City" class="text-danger"></span>
                            </div>
                            <div class="col-md-3">
                                <label asp-for="ShippingAddress.PostCode" class="form-label"></label>
                                <input asp-for="ShippingAddress.PostCode" class="form-control" id="shipping-postcode" required>
                                <span asp-validation-for="ShippingAddress.PostCode" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="ShippingAddress.Phone" class="form-label"></label>
                                <input asp-for="ShippingAddress.Phone" class="form-control" id="shipping-phone" required>
                                <span asp-validation-for="ShippingAddress.Phone" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Billing Address -->
                <div class="checkout-card mb-4">
                    <div class="card-body p-4">
                        <h2 class="h4 mb-3">Billing Address</h2>
                        <hr>
                        <div class="form-check mb-3">
                            <input asp-for="BillingSameAsShipping" class="form-check-input" type="checkbox" id="sameAsShipping">
                            <label class="form-check-label" for="sameAsShipping">
                                Same as shipping address
                            </label>
                        </div>
                        <div id="billingAddressForm" class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="@Model.BillingAddress.Name" class="form-label"></label>
                                <input asp-for="@Model.BillingAddress.Name" class="form-control" id="billing-name" required>
                                <span asp-validation-for="@Model.BillingAddress.Name" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label asp-for="@Model.BillingAddress.StreetAddress" class="form-label"></label>
                                <input asp-for="@Model.BillingAddress.StreetAddress" class="form-control" id="billing-line" required>
                                <span asp-validation-for="@Model.BillingAddress.StreetAddress" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="@Model.BillingAddress.City" class="form-label"></label>
                                <select asp-for="@Model.BillingAddress.City" class="form-select" id="billing-city" required>
                                    <option value="">Choose...</option>
                                    <option value="Dhaka">Dhaka</option>
                                    <option value="Rajshahi">Rajshahi</option>
                                    <option value="Sylhet">Sylhet</option>
                                </select>
                                <span asp-validation-for="@Model.BillingAddress.City" class="text-danger"></span>
                            </div>
                            <div class="col-md-3">
                                <label asp-for="BillingAddress.PostCode" class="form-label"></label>
                                <input asp-for="BillingAddress.PostCode" class="form-control" id="billing-postcode" required>
                                <span asp-validation-for="BillingAddress.PostCode" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="BillingAddress.Phone" class="form-label"></label>
                                <input asp-for="BillingAddress.Phone" class="form-control" id="billing-phone" required>
                                <span asp-validation-for="BillingAddress.Phone" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="checkout-card mb-4">
                    <div class="card-body p-4">
                        <h2 class="h4 mb-3">Payment Method</h2>
                        <hr>

                        <div class="mb-4">
                            <div class="form-check mb-3">
                                <input asp-for="Payment.Method" class="form-check-input" type="radio" id="cardPayment" value="Card" checked>
                                <label class="form-check-label d-flex align-items-center" for="cardPayment">
                                    <i class="bi bi-credit-card fs-4 me-2 text-primary"></i>
                                    <span class="fw-medium">Credit/Debit Card</span>
                                </label>
                            </div>

                            <div id="cardPaymentDetails" class="ps-4 mb-3">
                                <div class="card border-0 bg-light">
                                    <div class="card-body p-3">
                                        <div class="row g-3">

                                            <div class="col-md-6">
                                                <label asp-for="@Model.Payment.CardPayment.CardNumber" class="form-label"></label>
                                                <div class="input-group">
                                                    <input asp-for="@Model.Payment.CardPayment.CardNumber" class="form-control" placeholder="XXXX XXXX XXXX XXXX" required>
                                                    <span class="input-group-text">
                                                        <i class="bi bi-lock-fill"></i>
                                                    </span>
                                                </div>
                                                <span asp-validation-for="@Model.Payment.CardPayment.CardNumber" class="text-danger"></span>
                                            </div>
                                            <div class="col-md-4">
                                                <label asp-for="@Model.Payment.CardPayment.ExpiryMonth" class="form-label"></label>
                                                <select asp-for="@Model.Payment.CardPayment.ExpiryMonth" class="form-select" required>
                                                    <option value="">Month</option>
                                                    <option value="01">01</option>
                                                    <option value="02">02</option>
                                                    <option value="03">03</option>
                                                    <option value="04">04</option>
                                                    <option value="05">05</option>
                                                    <option value="06">06</option>
                                                    <option value="07">07</option>
                                                    <option value="08">08</option>
                                                    <option value="09">09</option>
                                                    <option value="10">10</option>
                                                    <option value="11">11</option>
                                                    <option value="12">12</option>
                                                </select>
                                                <span asp-validation-for="@Model.Payment.CardPayment.ExpiryMonth" class="text-danger"></span>
                                            </div>
                                            <div class="col-md-4">
                                                <label asp-for="@Model.Payment.CardPayment.ExpiryYear" class="form-label"></label>
                                                <select asp-for="@Model.Payment.CardPayment.ExpiryYear" class="form-select" required>
                                                    <option value="">Year</option>
                                                    <option value="2025">2025</option>
                                                    <option value="2026">2026</option>
                                                    <option value="2027">2027</option>
                                                    <option value="2028">2028</option>
                                                    <option value="2029">2029</option>
                                                    <option value="2030">2030</option>
                                                </select>
                                                <span asp-validation-for="@Model.Payment.CardPayment.ExpiryYear" class="text-danger"></span>
                                            </div>
                                            <div class="col-md-4">
                                                <label asp-for="@Model.Payment.CardPayment.CVV" class="form-label"></label>
                                                <div class="input-group">
                                                    <input asp-for="@Model.Payment.CardPayment.CVV" class="form-control" required maxlength="4">
                                                    <span class="input-group-text" data-bs-toggle="tooltip" data-bs-title="3 or 4 digit security code on the back of your card">
                                                        <i class="bi bi-question-circle"></i>
                                                    </span>
                                                </div>
                                                <span asp-validation-for="@Model.Payment.CardPayment.CVV" class="text-danger"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-check">
                                <input asp-for="@Model.Payment.Method" class="form-check-input" type="radio" id="codPayment" value="COD">
                                <label class="form-check-label d-flex align-items-center" for="codPayment">
                                    <i class="bi bi-cash-stack fs-4 me-2 text-success"></i>
                                    <span class="fw-medium">Cash on Delivery</span>
                                </label>
                                <div id="codPaymentDetails" class="d-none mt-2 ps-4">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body">
                                            <p class="text-muted mb-0">Pay with cash upon receipt of your order. Please have the exact amount ready.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="col-lg-4">
                <div class="checkout-card mb-4 position-sticky" style="top: 2rem;">
                    <div class="card-body p-4">
                        <h2 class="h4 mb-3">Order Summary</h2>
                        <hr>

                        <!-- Cart Items -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h3 class="h6 mb-0">Items (@Model.Items.Count)</h3>
                            </div>

                            @foreach (var item in Model.Items)
                            {
                                <div class="d-flex gap-3 mb-3 pb-3 border-bottom">
                                    <img src="@item.Book.ImageUrl" alt="@item.Book.Title cover" class="book-cover">
                                    <div class="flex-grow-1">
                                        <h4 class="h6 mb-1">@item.Book.Title</h4>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-dark fw-medium">$@item.Book.Price.ToString("0.00")</span>
                                            <span class="text-muted small">Qty: @item.Quantity</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Price Details -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Subtotal</span>
                                <span>$@Model.Items.Sum(i => i.Book.Price * i.Quantity).ToString("0.00")</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Shipping</span>
                                <span>$0</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="fw-bold">Total</span>
                                <span class="fw-bold">$@Model.Items.Sum(i => i.Book.Price * i.Quantity).ToString("0.00")</span>
                            </div>
                        </div>

                        <!-- Checkout Button -->
                        <button class="btn btn-primary w-100 py-3 d-flex align-items-center justify-content-center" type="submit">
                            <span class="me-2">Complete Order</span>
                            <i class="bi bi-arrow-right"></i>
                        </button>

                        <div class="mt-3 text-center">
                            <div class="d-flex justify-content-center gap-3 mb-2">
                                <i class="bi bi-shield-lock fs-5 text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            function copyShippingToBilling() {
                $('#billing-name').val($('#shipping-name').val());
                $('#billing-line').val($('#shipping-line').val());
                $('#billing-city').val($('#shipping-city').val());
                $('#billing-postcode').val($('#shipping-postcode').val());
                $('#billing-phone').val($('#shipping-phone').val());
            }

            function clearBillingFields() {
                $('#billing-name').val('');
                $('#billing-line').val('');
                $('#billing-city').val('');
                $('#billing-postcode').val('');
                $('#billing-phone').val('');
            }

            $('#sameAsShipping').change(function() {
                if ($(this).is(':checked')) {
                    $('#billingAddressForm').addClass('d-none');
                    copyShippingToBilling();
                } else {
                    $('#billingAddressForm').removeClass('d-none');
                    clearBillingFields();
                }
            });

            if ($('#sameAsShipping').is(':checked')) {
                $('#billingAddressForm').addClass('d-none');
                copyShippingToBilling();
            }

            $('#shipping-name, #shipping-line, #shipping-city, #shipping-postcode, #shipping-phone').on('change keyup', function() {
                if ($('#sameAsShipping').is(':checked')) {
                    copyShippingToBilling();
                }
            });

            $('#cardPayment').change(function() {
                if ($(this).is(':checked')) {
                    $('#cardPaymentDetails').removeClass('d-none');
                    $('#codPaymentDetails').addClass('d-none');
                }
            });

            $('#codPayment').change(function() {
                if ($(this).is(':checked')) {
                    $('#cardPaymentDetails').addClass('d-none');
                    $('#codPaymentDetails').removeClass('d-none');
                }
            });
        });
    </script>
}